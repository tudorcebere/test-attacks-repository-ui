<script type="module">
  import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";

  let deploymentsData = [];
  // Initialize sidebar state
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize all sections as expanded
    // Load deployments data
    const dataScript = document.getElementById('deployments-data');
    if (dataScript) {
      deploymentsData = JSON.parse(dataScript.textContent);
    }

    // Initialize link prefetching for sidebar links
    initializeLinkPrefetching();
    // Add click handlers to deployment rows
    const deploymentRows = document.querySelectorAll('.deployment-row');
    deploymentRows.forEach(function(row, index) {
      row.addEventListener('click', function() {
        selectDeploymentRow(index); 
      });
    });

    // Create modal overlay for mobile
    createModalOverlay();

    // Add window resize event listener
    window.addEventListener('resize', function() {
      const sidebar = document.querySelector('.docs-sidebar');
      if (window.innerWidth > 1920 && sidebar && sidebar.classList.contains('collapsed')) {
        sidebar.classList.remove('collapsed');
      }
    });
  });

  function createModalOverlay() {
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.addEventListener('click', function() {
      clearSelection();
    });
    document.body.appendChild(overlay);
  }

  function toggleSidebar() {
    const sidebar = document.querySelector('.docs-sidebar');
    if(sidebar.classList.contains('collapsed')) {
      sidebar.classList.remove('collapsed');
      clearSelection();
    } else {
      sidebar.classList.add('collapsed');
    }
  }

  // Expose function to global scope
  window.toggleSidebar = toggleSidebar;

  function toggleMobileSidebar() {
    const sidebar = document.querySelector('.docs-sidebar');
    const body = document.body;
    body.classList.toggle('sidebar-open');
    sidebar.classList.toggle('visible');
  }

  window.toggleMobileSidebar = toggleMobileSidebar;

  function selectDeploymentRow(index) {
    const sidebar = document.querySelector('.docs-sidebar');
    const sidePanel = document.querySelector('.side-panel');
    const sidePanelContainer = document.querySelector('.side-panel-container');
    const deploymentDetailsDiv = document.getElementById('deployment-details');
    const modalOverlay = document.querySelector('.modal-overlay');
    
    // Check if the clicked row is already selected
    const selectedRow = document.querySelector(`.deployment-row[data-index="${index}"]`);
    const isAlreadySelected = selectedRow && selectedRow.classList.contains('selected');
    
    if (isAlreadySelected) {
      // If the same row is clicked again, close the side panel
      clearSelection();
      return;
    }

    // Remove selected class from all rows
    const allRows = document.querySelectorAll('.deployment-row');
    allRows.forEach(function(row) {
      row.classList.remove('selected');
    });

    // Add selected class to clicked row
    if (selectedRow) {
      selectedRow.classList.add('selected');
    }

    // Get deployment data
    const deployment = deploymentsData[index];
    if (deployment) {
      // Store current deployment index globally for download function
      window.currentDeploymentIndex = index;
      
      // Collapse sidebar and expand side panel container
      if (sidebar && window.innerWidth < 1920) {
        sidebar.classList.add('collapsed');
      }
      
      // Expand side panel container and panel
      if (sidePanelContainer) {
        sidePanelContainer.classList.add('expanded');
      }
      if (sidePanel) {
        sidePanel.classList.add('expanded');
      }

      // Show modal overlay on mobile
      if (modalOverlay && window.innerWidth <= 768) {
        modalOverlay.classList.add('active');
      }
      
      // Generate details HTML
      const detailsHTML = generateDeploymentDetailsHTML(deployment);
      deploymentDetailsDiv.innerHTML = detailsHTML;
    }
    MathJax.typeset();
  }

  function objectToHTML(deploymentObject) {
    let html = '';
    for (let [key, value] of Object.entries(deploymentObject)) {
      if (value === null) {
        continue;
      }
      const label = key.split('_').join(' ');
      if (value?.length < 40) {
        html += 
          `<table><tr>
            <th style="text-transform: capitalize;">${label}</th>
            <td>${marked.parse(String(value))}</td>
          </tr></table>`
      } else if (typeof value !== 'object') {
        html += 
          `<div>
            <div class="section-sub-heading" style="text-transform: capitalize;">${label}</div>
            <div>${marked.parse(String(value))}</div>
          </div>`
      } else {
        const inner = objectToHTML(value);
        html += 
          `<div class="deployment-section-block"><div class="deployment-section-header" style="text-transform: capitalize;">
            ${label}
          </div>
          ${inner}</div>`
      }
    }
    return html;
  }

  function generateDeploymentDetailsHTML(deployment) {
    let deploymentHeader = `
      <div class="deployment-header-container">
        <div class="deployment-header">
          <div>
            <div>${deployment.name || 'Deployment Details'}</div>
          </div>
          <button class="download-btn" onClick="downloadDeployment()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <mask id="mask0_509_4001" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="16"
                      height="16">
                      <rect width="16" height="16" fill="#D9D9D9" />
                  </mask>
                  <g mask="url(#mask0_509_4001)">
                      <path
                          d="M7.49618 10.9423C7.40451 10.9423 7.31858 10.9263 7.23837 10.8942C7.15816 10.8622 7.08623 10.8141 7.02257 10.75L4.31076 8.01923C4.17072 7.87936 4.10388 7.71622 4.11024 7.52981C4.11661 7.34327 4.18676 7.17949 4.32069 7.03846C4.46685 6.89744 4.63223 6.82692 4.81684 6.82692C5.00145 6.82692 5.16377 6.89744 5.30382 7.03846L6.8125 8.57692V2.69231C6.8125 2.49615 6.878 2.33173 7.00901 2.19904C7.14002 2.06635 7.30234 2 7.49599 2C7.68964 2 7.8533 2.06635 7.98698 2.19904C8.12066 2.33173 8.1875 2.49615 8.1875 2.69231V8.57692L9.71528 7.03846C9.85112 6.89744 10.0124 6.83013 10.199 6.83654C10.3858 6.84295 10.5522 6.91667 10.6984 7.05769C10.8323 7.19872 10.8993 7.36218 10.8993 7.54808C10.8993 7.73397 10.8293 7.89744 10.6892 8.03846L7.97743 10.75C7.90868 10.8141 7.8342 10.8622 7.75399 10.8942C7.67378 10.9263 7.58785 10.9423 7.49618 10.9423ZM3.36965 14C2.99127 14 2.6684 13.8644 2.40104 13.5933C2.13368 13.3221 2 12.9962 2 12.6154V11.9231C2 11.7269 2.0655 11.5625 2.19651 11.4298C2.32752 11.2971 2.48984 11.2308 2.68349 11.2308C2.87714 11.2308 3.0408 11.2971 3.17448 11.4298C3.30816 11.5625 3.375 11.7269 3.375 11.9231V12.6154H11.625V11.9231C11.625 11.7269 11.6905 11.5625 11.8215 11.4298C11.9525 11.2971 12.1148 11.2308 12.3085 11.2308C12.5021 11.2308 12.6658 11.2971 12.7995 11.4298C12.9332 11.5625 13 11.7269 13 11.9231V12.6154C13 12.9962 12.8653 13.3221 12.5959 13.5933C12.3265 13.8644 12.0026 14 11.6242 14H3.36965Z"
                          fill="#181818" />
                  </g>
              </svg>
          </button>
        </div>
        <div class="section-spacer"></div>
      </div>`;
    
    let deploymentSection = '<div class="deployment-section">';
    deploymentSection += objectToHTML(deployment);
    deploymentSection += '</div>';

    return deploymentHeader + deploymentSection;
  }

  function downloadDeployment() {
    try {
      // Get the current deployment from the stored index
      if (window.currentDeploymentIndex === undefined || !deploymentsData[window.currentDeploymentIndex]) {
        alert('No deployment selected for download.');
        return;
      }
      
      const deploymentData = deploymentsData[window.currentDeploymentIndex];

      // Convert deployment data to YAML format
      const yamlContent = convertToYAML(deploymentData);
      
      // Create filename based on deployment name or curator
      const filename = `${(deploymentData.name || deploymentData.data_curator || 'deployment').replace(/[^a-z0-9]/gi, '_').toLowerCase()}.yaml`;
      
      // Create blob and download
      const blob = new Blob([yamlContent], { type: 'text/yaml;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      
      // Create temporary link and trigger download
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Clean up the URL object
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Error downloading deployment:', error);
      alert('Error downloading deployment file. Please try again.');
    }
  }

  // Expose function to global scope
  window.downloadDeployment = downloadDeployment;

  function convertToYAML(data) {
    // Simple YAML converter - handles basic data structures
    function toYAML(obj, indent = 0) {
      const spaces = '  '.repeat(indent);
      let yaml = '';
      
      if (obj === null || obj === undefined) {
        return 'null';
      }
      
      if (typeof obj === 'string') {
        // Handle strings that need quoting or escaping
        if (obj.includes('\n')) {
          // Multi-line strings use literal block scalar
          const lines = obj.split('\n');
          yaml = '|\n';
          lines.forEach(line => {
            yaml += `${spaces}  ${line}\n`;
          });
          return yaml.slice(0, -1); // Remove last newline
        } else if (obj.includes('"') || obj.includes("'") || obj.includes(':') || obj.includes('[') || obj.includes(']') || obj.includes('{') || obj.includes('}') || obj.includes('#')) {
          // Quote strings that contain special YAML characters
          return `"${obj.replace(/"/g, '\\"')}"`;
        } else {
          // Simple strings don't need quotes
          return obj;
        }
      }
      
      if (typeof obj === 'number' || typeof obj === 'boolean') {
        return obj.toString();
      }
      
      if (Array.isArray(obj)) {
        if (obj.length === 0) return '[]';
        yaml = '\n';
        obj.forEach(item => {
          const itemYaml = toYAML(item, indent + 1);
          if (itemYaml.includes('\n')) {
            yaml += `${spaces}- |\n${spaces}  ${itemYaml.replace(/\n/g, `\n${spaces}  `)}\n`;
          } else {
            yaml += `${spaces}- ${itemYaml}\n`;
          }
        });
        return yaml.slice(0, -1); // Remove last newline
      }
      
      if (typeof obj === 'object') {
        const keys = Object.keys(obj).filter(key => {
          const value = obj[key];
          return value !== null && value !== undefined && value !== '';
        });
        
        if (keys.length === 0) return '{}';
        
        yaml = '\n';
        keys.forEach((key, index) => {
          const value = obj[key];
          const yamlValue = toYAML(value, indent + 1);
          
          if (yamlValue.startsWith('\n')) {
            // Object or array value
            yaml += `${spaces}${key}:${yamlValue}\n`;
          } else {
            // Simple value
            yaml += `${spaces}${key}: ${yamlValue}\n`;
          }
        });
        return yaml.slice(0, -1); // Remove last newline
      }
      
      return String(obj);
    }
    
    // Wrap the deployment in the expected structure
    const wrappedData = {
      ...data
    };
    
    return toYAML(wrappedData);
  }

  function clearSelection() {
    const sidebar = document.querySelector('.docs-sidebar');
    const sidePanel = document.querySelector('.side-panel');
    const sidePanelContainer = document.querySelector('.side-panel-container');
    const deploymentDetailsDiv = document.getElementById('deployment-details');
    const modalOverlay = document.querySelector('.modal-overlay');
    
    // Remove selected class from all rows
    const allRows = document.querySelectorAll('.deployment-row');
    allRows.forEach(function(row) {
      row.classList.remove('selected');
    });

    // Expand sidebar
    if (sidebar) {
      sidebar.classList.remove('collapsed');
    }

    // Collapse side panel and container
    if (sidePanel) {
      sidePanel.classList.remove('expanded');
    }
    if (sidePanelContainer) {
      sidePanelContainer.classList.remove('expanded');
    }

    // Hide modal overlay
    if (modalOverlay) {
      modalOverlay.classList.remove('active');
    }

    // Reset side panel content
    deploymentDetailsDiv.innerHTML = '';
  }

  function initializeLinkPrefetching() {
    const prefetchedLinks = new Set();
    let prefetchTimeout;

    // Select all sidebar navigation links
    const sidebarLinks = document.querySelectorAll('.sidebar-link[href], .sidebar-toggle[href]');

    sidebarLinks.forEach(link => {
      link.addEventListener('mouseenter', function() {
        // Clear any existing timeout
        if (prefetchTimeout) {
          clearTimeout(prefetchTimeout);
        }

        // Add a small delay to avoid prefetching on quick mouse movements
        prefetchTimeout = setTimeout(() => {
          const href = this.getAttribute('href');
          
          // Skip if already prefetched, not a valid URL, or is an anchor link
          if (!href || 
              href.startsWith('#') || 
              href.startsWith('javascript:') ||
              href.startsWith('mailto:') ||
              prefetchedLinks.has(href)) {
            return;
          }

          // Create prefetch link element
          const prefetchLink = document.createElement('link');
          prefetchLink.rel = 'prefetch';
          prefetchLink.href = href;
          prefetchLink.as = 'document';
          
          // Add error handling to prevent console errors
          prefetchLink.addEventListener('error', function() {
            // Silently handle prefetch errors
          });

          // Add to head
          document.head.appendChild(prefetchLink);
          prefetchedLinks.add(href);

          // Optional: Remove prefetch link after a delay to keep DOM clean
          setTimeout(() => {
            if (prefetchLink.parentNode) {
              prefetchLink.parentNode.removeChild(prefetchLink);
            }
          }, 60000); // Remove after 60 seconds

        }, 150); // 150ms delay to avoid excessive prefetching
      });

      // Clear timeout on mouse leave to prevent unnecessary prefetching
      link.addEventListener('mouseleave', function() {
        if (prefetchTimeout) {
          clearTimeout(prefetchTimeout);
          prefetchTimeout = null;
        }
      });
    });
  }
</script>
